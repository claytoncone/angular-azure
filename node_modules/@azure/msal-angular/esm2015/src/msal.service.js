/*
 * Copyright (c) Microsoft Corporation. All rights reserved.
 * Licensed under the MIT License.
 */
import { __decorate, __param } from "tslib";
import { Inject, Injectable } from "@angular/core";
import { UserAgentApplication, UrlUtils } from "msal";
import { Router } from "@angular/router";
import { BroadcastService } from "./broadcast.service";
import { MSALError } from "./MSALError";
import { MSAL_CONFIG, MSAL_CONFIG_ANGULAR } from "./constants";
import { Minimatch } from "minimatch";
const buildMsalConfig = (config) => {
    return Object.assign(Object.assign({}, config), { framework: Object.assign(Object.assign({}, config.framework), { isAngular: true }) });
};
const ɵ0 = buildMsalConfig;
let MsalService = class MsalService extends UserAgentApplication {
    constructor(msalConfig, msalAngularConfig, router, broadcastService) {
        super(buildMsalConfig(msalConfig));
        this.msalConfig = msalConfig;
        this.msalAngularConfig = msalAngularConfig;
        this.router = router;
        this.broadcastService = broadcastService;
        window.addEventListener("msal:popUpHashChanged", () => {
            this.getLogger().verbose("popUpHashChanged ");
        });
        window.addEventListener("msal:popUpClosed", (e) => {
            const errorParts = e.detail.split("|");
            const msalError = new MSALError(errorParts[0], errorParts[1]);
            if (this.getLoginInProgress()) {
                broadcastService.broadcast("msal:loginFailure", msalError);
                this.setloginInProgress(false);
            }
            else if (this.getAcquireTokenInProgress()) {
                broadcastService.broadcast("msal:acquireTokenFailure", msalError);
                this.setAcquireTokenInProgress(false);
            }
        });
    }
    loginPopup(request) {
        return super.loginPopup(request)
            .then((authResponse) => {
            this.broadcastService.broadcast("msal:loginSuccess", authResponse);
            return authResponse;
        })
            .catch((error) => {
            this.broadcastService.broadcast("msal:loginFailure", error);
            this.getLogger().error("Error during login:\n" + error.errorMessage);
            throw error;
        });
    }
    ssoSilent(request) {
        return super.ssoSilent(request)
            .then((authResponse) => {
            this.broadcastService.broadcast("msal:ssoSuccess", authResponse);
            return authResponse;
        })
            .catch((error) => {
            this.broadcastService.broadcast("msal:ssoFailure", error);
            this.getLogger().error("Error during login:\n" + error.errorMessage);
            throw error;
        });
    }
    acquireTokenSilent(request) {
        return super.acquireTokenSilent(request)
            .then((authResponse) => {
            this.broadcastService.broadcast("msal:acquireTokenSuccess", authResponse);
            return authResponse;
        })
            .catch((error) => {
            this.broadcastService.broadcast("msal:acquireTokenFailure", error);
            this.getLogger().error("Error when acquiring token for scopes: " + request.scopes + " " + error);
            throw error;
        });
    }
    acquireTokenPopup(request) {
        return super.acquireTokenPopup(request)
            .then((authResponse) => {
            this.broadcastService.broadcast("msal:acquireTokenSuccess", authResponse);
            return authResponse;
        })
            .catch((error) => {
            this.broadcastService.broadcast("msal:acquireTokenFailure", error);
            this.getLogger().error("Error when acquiring token for scopes : " + request.scopes + " " + error);
            throw error;
        });
    }
    handleRedirectCallback(authOrTokenCallback, errorReceivedCallback) {
        super.handleRedirectCallback((authError, authResponse) => {
            if (authError) {
                if (!this.getAccount()) {
                    this.broadcastService.broadcast("msal:loginFailure", authError);
                }
                else {
                    this.broadcastService.broadcast("msal:acquireTokenFailure", authError);
                }
                if (errorReceivedCallback) {
                    errorReceivedCallback(authError, authResponse.accountState);
                }
                else {
                    authOrTokenCallback(authError, authResponse);
                }
            }
            else if (authResponse) {
                if (authResponse.tokenType === "id_token") {
                    this.broadcastService.broadcast("msal:loginSuccess", authResponse);
                }
                else {
                    this.broadcastService.broadcast("msal:acquireTokenSuccess", authResponse);
                }
                if (errorReceivedCallback) {
                    authOrTokenCallback(authResponse);
                }
                else {
                    authOrTokenCallback(null, authResponse);
                }
            }
        });
    }
    clearCacheForScope(accessToken) {
        return super.clearCacheForScope(accessToken);
    }
    getScopesForEndpoint(endpoint) {
        if ((this.msalConfig.framework && this.msalConfig.framework.unprotectedResources) || (this.msalAngularConfig && this.msalAngularConfig.unprotectedResources)) {
            this.getLogger().info("unprotectedResources is deprecated and ignored. msalAngularConfig.protectedResourceMap now supports glob patterns");
        }
        const frameworkProtectedResourceMap = this.msalConfig.framework && this.msalConfig.framework.protectedResourceMap;
        if (frameworkProtectedResourceMap) {
            this.getLogger().info("msalConfig.framework.protectedResourceMap is deprecated, use msalAngularConfig.protectedResourceMap");
        }
        const protectedResourceMap = frameworkProtectedResourceMap && frameworkProtectedResourceMap.size ? frameworkProtectedResourceMap : new Map(this.msalAngularConfig.protectedResourceMap);
        const protectedResourcesArray = Array.from(protectedResourceMap.keys());
        const keyMatchesEndpointArray = protectedResourcesArray.filter(key => {
            const minimatch = new Minimatch(key);
            return minimatch.match(endpoint) || endpoint.indexOf(key) > -1;
        });
        // process all protected resources and send the first matched resource
        if (keyMatchesEndpointArray.length > 0) {
            if (keyMatchesEndpointArray.length > 1) {
                this.getLogger().warning("Multiple entries in protectedResourceMap found for resource. Using first entry.");
                this.getLogger().warningPii(`Multiple entries found for: ${endpoint}`);
            }
            const keyForEndpoint = keyMatchesEndpointArray[0];
            if (keyForEndpoint) {
                return protectedResourceMap.get(keyForEndpoint);
            }
        }
        /*
         * default resource will be clientid if nothing specified
         * App will use idtoken for calls to itself
         * check if it's staring from http or https, needs to match with app host
         */
        if (endpoint.indexOf("http://") > -1 || endpoint.indexOf("https://") > -1) {
            if (UrlUtils.getHostFromUri(endpoint) === UrlUtils.getHostFromUri(super.getRedirectUri())) {
                return new Array(this.msalConfig.auth.clientId);
            }
        }
        else {
            /*
             * in angular level, the url for $http interceptor call could be relative url,
             * if it's relative call, we'll treat it as app backend call.
             */
            return new Array(this.msalConfig.auth.clientId);
        }
        // if not the app's own backend or not a domain listed in the endpoints structure
        return null;
    }
};
MsalService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [MSAL_CONFIG,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [MSAL_CONFIG_ANGULAR,] }] },
    { type: Router },
    { type: BroadcastService }
];
MsalService = __decorate([
    Injectable(),
    __param(0, Inject(MSAL_CONFIG)),
    __param(1, Inject(MSAL_CONFIG_ANGULAR))
], MsalService);
export { MsalService };
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXNhbC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGF6dXJlL21zYWwtYW5ndWxhci8iLCJzb3VyY2VzIjpbInNyYy9tc2FsLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHOztBQUVILE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFDSCxvQkFBb0IsRUFRcEIsUUFBUSxFQUNYLE1BQU0sTUFBTSxDQUFDO0FBQ2QsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLHFCQUFxQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFFeEMsT0FBTyxFQUFFLFdBQVcsRUFBRSxtQkFBbUIsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUUvRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRXRDLE1BQU0sZUFBZSxHQUFHLENBQUMsTUFBcUIsRUFBa0IsRUFBRTtJQUM5RCx1Q0FDTyxNQUFNLEtBQ1QsU0FBUyxrQ0FDRixNQUFNLENBQUMsU0FBUyxLQUNuQixTQUFTLEVBQUUsSUFBSSxPQUVyQjtBQUNOLENBQUMsQ0FBQzs7QUFHRixJQUFhLFdBQVcsR0FBeEIsTUFBYSxXQUFZLFNBQVEsb0JBQW9CO0lBRWpELFlBQ2lDLFVBQXlCLEVBQ2pCLGlCQUEyQyxFQUN4RSxNQUFjLEVBQ2QsZ0JBQWtDO1FBRTFDLEtBQUssQ0FBQyxlQUFlLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztRQUxOLGVBQVUsR0FBVixVQUFVLENBQWU7UUFDakIsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUEwQjtRQUN4RSxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2QscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUkxQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsdUJBQXVC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LENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDO2FBQ25EO1NBQ0o7UUFFRDs7OztXQUlHO1FBQ0gsSUFBSSxRQUFRLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUU7WUFDdkUsSUFBSSxRQUFRLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxLQUFLLFFBQVEsQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDLEVBQUU7Z0JBQ3ZGLE9BQU8sSUFBSSxLQUFLLENBQVMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDM0Q7U0FDSjthQUFNO1lBQ0g7OztlQUdHO1lBQ0gsT0FBTyxJQUFJLEtBQUssQ0FBUyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUMzRDtRQUVELGlGQUFpRjtRQUNqRixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0NBQ0osQ0FBQTs7NENBdktRLE1BQU0sU0FBQyxXQUFXOzRDQUNsQixNQUFNLFNBQUMsbUJBQW1CO1lBQ1gsTUFBTTtZQUNJLGdCQUFnQjs7QUFOckMsV0FBVztJQUR2QixVQUFVLEVBQUU7SUFJSixXQUFBLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQTtJQUNuQixXQUFBLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFBO0dBSnZCLFdBQVcsQ0EwS3ZCO1NBMUtZLFdBQVciLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuICogTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG4gKi9cclxuXHJcbmltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7XHJcbiAgICBVc2VyQWdlbnRBcHBsaWNhdGlvbixcclxuICAgIENvbmZpZ3VyYXRpb24sXHJcbiAgICBBdXRoZW50aWNhdGlvblBhcmFtZXRlcnMsXHJcbiAgICBBdXRoUmVzcG9uc2UsXHJcbiAgICBBdXRoRXJyb3IsXHJcbiAgICBhdXRoUmVzcG9uc2VDYWxsYmFjayxcclxuICAgIGVycm9yUmVjZWl2ZWRDYWxsYmFjayxcclxuICAgIHRva2VuUmVjZWl2ZWRDYWxsYmFjayxcclxuICAgIFVybFV0aWxzXHJcbn0gZnJvbSBcIm1zYWxcIjtcclxuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSBcIkBhbmd1bGFyL3JvdXRlclwiO1xyXG5pbXBvcnQge0Jyb2FkY2FzdFNlcnZpY2V9IGZyb20gXCIuL2Jyb2FkY2FzdC5zZXJ2aWNlXCI7XHJcbmltcG9ydCB7IE1TQUxFcnJvciB9IGZyb20gXCIuL01TQUxFcnJvclwiO1xyXG5pbXBvcnQgeyBNc2FsQW5ndWxhckNvbmZpZ3VyYXRpb24gfSBmcm9tIFwiLi9tc2FsLWFuZ3VsYXIuY29uZmlndXJhdGlvblwiO1xyXG5pbXBvcnQgeyBNU0FMX0NPTkZJRywgTVNBTF9DT05GSUdfQU5HVUxBUiB9IGZyb20gXCIuL2NvbnN0YW50c1wiO1xyXG5cclxuaW1wb3J0IHsgTWluaW1hdGNoIH0gZnJvbSBcIm1pbmltYXRjaFwiO1xyXG5cclxuY29uc3QgYnVpbGRNc2FsQ29uZmlnID0gKGNvbmZpZzogQ29uZmlndXJhdGlvbikgOiBDb25maWd1cmF0aW9uID0+IHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgLi4uY29uZmlnLFxyXG4gICAgICAgIGZyYW1ld29yazoge1xyXG4gICAgICAgICAgICAuLi5jb25maWcuZnJhbWV3b3JrLFxyXG4gICAgICAgICAgICBpc0FuZ3VsYXI6IHRydWVcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG59O1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgTXNhbFNlcnZpY2UgZXh0ZW5kcyBVc2VyQWdlbnRBcHBsaWNhdGlvbiB7XHJcblxyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgQEluamVjdChNU0FMX0NPTkZJRykgcHJpdmF0ZSBtc2FsQ29uZmlnOiBDb25maWd1cmF0aW9uLFxyXG4gICAgICAgIEBJbmplY3QoTVNBTF9DT05GSUdfQU5HVUxBUikgcHJpdmF0ZSBtc2FsQW5ndWxhckNvbmZpZzogTXNhbEFuZ3VsYXJDb25maWd1cmF0aW9uLFxyXG4gICAgICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIsXHJcbiAgICAgICAgcHJpdmF0ZSBicm9hZGNhc3RTZXJ2aWNlOiBCcm9hZGNhc3RTZXJ2aWNlXHJcbiAgICApIHtcclxuICAgICAgICBzdXBlcihidWlsZE1zYWxDb25maWcobXNhbENvbmZpZykpO1xyXG5cclxuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcIm1zYWw6cG9wVXBIYXNoQ2hhbmdlZFwiLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0TG9nZ2VyKCkudmVyYm9zZShcInBvcFVwSGFzaENoYW5nZWQgXCIpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcIm1zYWw6cG9wVXBDbG9zZWRcIiwgKGU6IEN1c3RvbUV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGVycm9yUGFydHMgPSBlLmRldGFpbC5zcGxpdChcInxcIik7XHJcbiAgICAgICAgICAgIGNvbnN0IG1zYWxFcnJvciA9IG5ldyBNU0FMRXJyb3IoZXJyb3JQYXJ0c1swXSwgZXJyb3JQYXJ0c1sxXSk7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmdldExvZ2luSW5Qcm9ncmVzcygpKSB7XHJcbiAgICAgICAgICAgICAgICBicm9hZGNhc3RTZXJ2aWNlLmJyb2FkY2FzdChcIm1zYWw6bG9naW5GYWlsdXJlXCIsIG1zYWxFcnJvcik7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldGxvZ2luSW5Qcm9ncmVzcyhmYWxzZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5nZXRBY3F1aXJlVG9rZW5JblByb2dyZXNzKCkpIHtcclxuICAgICAgICAgICAgICAgIGJyb2FkY2FzdFNlcnZpY2UuYnJvYWRjYXN0KFwibXNhbDphY3F1aXJlVG9rZW5GYWlsdXJlXCIsIG1zYWxFcnJvcik7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldEFjcXVpcmVUb2tlbkluUHJvZ3Jlc3MoZmFsc2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGxvZ2luUG9wdXAocmVxdWVzdD86IEF1dGhlbnRpY2F0aW9uUGFyYW1ldGVycyk6IFByb21pc2U8YW55PiB7XHJcbiAgICAgICAgcmV0dXJuIHN1cGVyLmxvZ2luUG9wdXAocmVxdWVzdClcclxuICAgICAgICAgICAgLnRoZW4oKGF1dGhSZXNwb25zZTogQXV0aFJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmJyb2FkY2FzdFNlcnZpY2UuYnJvYWRjYXN0KFwibXNhbDpsb2dpblN1Y2Nlc3NcIiwgYXV0aFJlc3BvbnNlKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhdXRoUmVzcG9uc2U7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaCgoZXJyb3I6IEF1dGhFcnJvcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5icm9hZGNhc3RTZXJ2aWNlLmJyb2FkY2FzdChcIm1zYWw6bG9naW5GYWlsdXJlXCIsIGVycm9yKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0TG9nZ2VyKCkuZXJyb3IoXCJFcnJvciBkdXJpbmcgbG9naW46XFxuXCIgKyBlcnJvci5lcnJvck1lc3NhZ2UpO1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzc29TaWxlbnQocmVxdWVzdDogQXV0aGVudGljYXRpb25QYXJhbWV0ZXJzKTogUHJvbWlzZTxBdXRoUmVzcG9uc2U+IHtcclxuICAgICAgICByZXR1cm4gc3VwZXIuc3NvU2lsZW50KHJlcXVlc3QpXHJcbiAgICAgICAgICAgIC50aGVuKChhdXRoUmVzcG9uc2U6IEF1dGhSZXNwb25zZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5icm9hZGNhc3RTZXJ2aWNlLmJyb2FkY2FzdChcIm1zYWw6c3NvU3VjY2Vzc1wiLCBhdXRoUmVzcG9uc2UpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGF1dGhSZXNwb25zZTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmNhdGNoKChlcnJvcjogQXV0aEVycm9yKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmJyb2FkY2FzdFNlcnZpY2UuYnJvYWRjYXN0KFwibXNhbDpzc29GYWlsdXJlXCIsIGVycm9yKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0TG9nZ2VyKCkuZXJyb3IoXCJFcnJvciBkdXJpbmcgbG9naW46XFxuXCIgKyBlcnJvci5lcnJvck1lc3NhZ2UpO1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhY3F1aXJlVG9rZW5TaWxlbnQocmVxdWVzdDogQXV0aGVudGljYXRpb25QYXJhbWV0ZXJzKTogUHJvbWlzZTxBdXRoUmVzcG9uc2U+IHtcclxuICAgICAgICByZXR1cm4gc3VwZXIuYWNxdWlyZVRva2VuU2lsZW50KHJlcXVlc3QpXHJcbiAgICAgICAgICAgIC50aGVuKChhdXRoUmVzcG9uc2U6IEF1dGhSZXNwb25zZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5icm9hZGNhc3RTZXJ2aWNlLmJyb2FkY2FzdChcIm1zYWw6YWNxdWlyZVRva2VuU3VjY2Vzc1wiLCBhdXRoUmVzcG9uc2UpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGF1dGhSZXNwb25zZTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmNhdGNoKChlcnJvcjogQXV0aEVycm9yKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmJyb2FkY2FzdFNlcnZpY2UuYnJvYWRjYXN0KFwibXNhbDphY3F1aXJlVG9rZW5GYWlsdXJlXCIsIGVycm9yKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0TG9nZ2VyKCkuZXJyb3IoXCJFcnJvciB3aGVuIGFjcXVpcmluZyB0b2tlbiBmb3Igc2NvcGVzOiBcIiArIHJlcXVlc3Quc2NvcGVzICsgXCIgXCIgKyBlcnJvcik7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhY3F1aXJlVG9rZW5Qb3B1cChyZXF1ZXN0OiBBdXRoZW50aWNhdGlvblBhcmFtZXRlcnMpOiBQcm9taXNlPEF1dGhSZXNwb25zZT4ge1xyXG4gICAgICAgIHJldHVybiBzdXBlci5hY3F1aXJlVG9rZW5Qb3B1cChyZXF1ZXN0KVxyXG4gICAgICAgICAgICAudGhlbigoYXV0aFJlc3BvbnNlOiBBdXRoUmVzcG9uc2UpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuYnJvYWRjYXN0U2VydmljZS5icm9hZGNhc3QoXCJtc2FsOmFjcXVpcmVUb2tlblN1Y2Nlc3NcIiwgYXV0aFJlc3BvbnNlKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhdXRoUmVzcG9uc2U7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaCgoZXJyb3I6IEF1dGhFcnJvcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5icm9hZGNhc3RTZXJ2aWNlLmJyb2FkY2FzdChcIm1zYWw6YWNxdWlyZVRva2VuRmFpbHVyZVwiLCBlcnJvcik7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmdldExvZ2dlcigpLmVycm9yKFwiRXJyb3Igd2hlbiBhY3F1aXJpbmcgdG9rZW4gZm9yIHNjb3BlcyA6IFwiICsgcmVxdWVzdC5zY29wZXMgKyBcIiBcIiArICBlcnJvcik7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgaGFuZGxlUmVkaXJlY3RDYWxsYmFjayh0b2tlblJlY2VpdmVkQ2FsbGJhY2s6IHRva2VuUmVjZWl2ZWRDYWxsYmFjaywgZXJyb3JSZWNlaXZlZENhbGxiYWNrOiBlcnJvclJlY2VpdmVkQ2FsbGJhY2spOiB2b2lkO1xyXG4gICAgaGFuZGxlUmVkaXJlY3RDYWxsYmFjayhhdXRoQ2FsbGJhY2s6IGF1dGhSZXNwb25zZUNhbGxiYWNrKTogdm9pZDtcclxuICAgIGhhbmRsZVJlZGlyZWN0Q2FsbGJhY2soYXV0aE9yVG9rZW5DYWxsYmFjazogYXV0aFJlc3BvbnNlQ2FsbGJhY2sgfCB0b2tlblJlY2VpdmVkQ2FsbGJhY2ssIGVycm9yUmVjZWl2ZWRDYWxsYmFjaz86IGVycm9yUmVjZWl2ZWRDYWxsYmFjayk6IHZvaWQge1xyXG4gICAgICAgIHN1cGVyLmhhbmRsZVJlZGlyZWN0Q2FsbGJhY2soKGF1dGhFcnJvcjogQXV0aEVycm9yLCBhdXRoUmVzcG9uc2U6IEF1dGhSZXNwb25zZSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoYXV0aEVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuZ2V0QWNjb3VudCgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5icm9hZGNhc3RTZXJ2aWNlLmJyb2FkY2FzdChcIm1zYWw6bG9naW5GYWlsdXJlXCIsIGF1dGhFcnJvcik7XHJcblxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmJyb2FkY2FzdFNlcnZpY2UuYnJvYWRjYXN0KFwibXNhbDphY3F1aXJlVG9rZW5GYWlsdXJlXCIsIGF1dGhFcnJvcik7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGVycm9yUmVjZWl2ZWRDYWxsYmFjaykge1xyXG4gICAgICAgICAgICAgICAgICAgIGVycm9yUmVjZWl2ZWRDYWxsYmFjayhhdXRoRXJyb3IsIGF1dGhSZXNwb25zZS5hY2NvdW50U3RhdGUpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAoYXV0aE9yVG9rZW5DYWxsYmFjayBhcyBhdXRoUmVzcG9uc2VDYWxsYmFjaykoYXV0aEVycm9yLCBhdXRoUmVzcG9uc2UpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfSBlbHNlIGlmIChhdXRoUmVzcG9uc2UpIHtcclxuICAgICAgICAgICAgICAgIGlmIChhdXRoUmVzcG9uc2UudG9rZW5UeXBlID09PSBcImlkX3Rva2VuXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmJyb2FkY2FzdFNlcnZpY2UuYnJvYWRjYXN0KFwibXNhbDpsb2dpblN1Y2Nlc3NcIiwgYXV0aFJlc3BvbnNlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5icm9hZGNhc3RTZXJ2aWNlLmJyb2FkY2FzdChcIm1zYWw6YWNxdWlyZVRva2VuU3VjY2Vzc1wiLCBhdXRoUmVzcG9uc2UpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmIChlcnJvclJlY2VpdmVkQ2FsbGJhY2spIHtcclxuICAgICAgICAgICAgICAgICAgICAoYXV0aE9yVG9rZW5DYWxsYmFjayBhcyB0b2tlblJlY2VpdmVkQ2FsbGJhY2spKGF1dGhSZXNwb25zZSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIChhdXRoT3JUb2tlbkNhbGxiYWNrIGFzIGF1dGhSZXNwb25zZUNhbGxiYWNrKShudWxsLCBhdXRoUmVzcG9uc2UpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBjbGVhckNhY2hlRm9yU2NvcGUoYWNjZXNzVG9rZW46IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiBzdXBlci5jbGVhckNhY2hlRm9yU2NvcGUoYWNjZXNzVG9rZW4pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRTY29wZXNGb3JFbmRwb2ludChlbmRwb2ludDogc3RyaW5nKSA6IEFycmF5PHN0cmluZz4ge1xyXG4gICAgICAgIGlmICgodGhpcy5tc2FsQ29uZmlnLmZyYW1ld29yayAmJiB0aGlzLm1zYWxDb25maWcuZnJhbWV3b3JrLnVucHJvdGVjdGVkUmVzb3VyY2VzKSB8fCAodGhpcy5tc2FsQW5ndWxhckNvbmZpZyAmJiB0aGlzLm1zYWxBbmd1bGFyQ29uZmlnLnVucHJvdGVjdGVkUmVzb3VyY2VzKSkge1xyXG4gICAgICAgICAgICB0aGlzLmdldExvZ2dlcigpLmluZm8oXCJ1bnByb3RlY3RlZFJlc291cmNlcyBpcyBkZXByZWNhdGVkIGFuZCBpZ25vcmVkLiBtc2FsQW5ndWxhckNvbmZpZy5wcm90ZWN0ZWRSZXNvdXJjZU1hcCBub3cgc3VwcG9ydHMgZ2xvYiBwYXR0ZXJuc1wiKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGZyYW1ld29ya1Byb3RlY3RlZFJlc291cmNlTWFwID0gdGhpcy5tc2FsQ29uZmlnLmZyYW1ld29yayAmJiB0aGlzLm1zYWxDb25maWcuZnJhbWV3b3JrLnByb3RlY3RlZFJlc291cmNlTWFwO1xyXG4gICAgICAgIGlmIChmcmFtZXdvcmtQcm90ZWN0ZWRSZXNvdXJjZU1hcCkge1xyXG4gICAgICAgICAgICB0aGlzLmdldExvZ2dlcigpLmluZm8oXCJtc2FsQ29uZmlnLmZyYW1ld29yay5wcm90ZWN0ZWRSZXNvdXJjZU1hcCBpcyBkZXByZWNhdGVkLCB1c2UgbXNhbEFuZ3VsYXJDb25maWcucHJvdGVjdGVkUmVzb3VyY2VNYXBcIik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBwcm90ZWN0ZWRSZXNvdXJjZU1hcCA9IGZyYW1ld29ya1Byb3RlY3RlZFJlc291cmNlTWFwICYmIGZyYW1ld29ya1Byb3RlY3RlZFJlc291cmNlTWFwLnNpemUgPyBmcmFtZXdvcmtQcm90ZWN0ZWRSZXNvdXJjZU1hcCA6IG5ldyBNYXAodGhpcy5tc2FsQW5ndWxhckNvbmZpZy5wcm90ZWN0ZWRSZXNvdXJjZU1hcCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3QgcHJvdGVjdGVkUmVzb3VyY2VzQXJyYXkgPSBBcnJheS5mcm9tKHByb3RlY3RlZFJlc291cmNlTWFwLmtleXMoKSk7XHJcbiAgICAgICAgY29uc3Qga2V5TWF0Y2hlc0VuZHBvaW50QXJyYXkgPSBwcm90ZWN0ZWRSZXNvdXJjZXNBcnJheS5maWx0ZXIoa2V5ID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbWluaW1hdGNoID0gbmV3IE1pbmltYXRjaChrZXkpO1xyXG4gICAgICAgICAgICByZXR1cm4gbWluaW1hdGNoLm1hdGNoKGVuZHBvaW50KSB8fCBlbmRwb2ludC5pbmRleE9mKGtleSkgPiAtMTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICAvLyBwcm9jZXNzIGFsbCBwcm90ZWN0ZWQgcmVzb3VyY2VzIGFuZCBzZW5kIHRoZSBmaXJzdCBtYXRjaGVkIHJlc291cmNlXHJcbiAgICAgICAgaWYgKGtleU1hdGNoZXNFbmRwb2ludEFycmF5Lmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgaWYgKGtleU1hdGNoZXNFbmRwb2ludEFycmF5Lmxlbmd0aCA+IDEpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0TG9nZ2VyKCkud2FybmluZyhcIk11bHRpcGxlIGVudHJpZXMgaW4gcHJvdGVjdGVkUmVzb3VyY2VNYXAgZm91bmQgZm9yIHJlc291cmNlLiBVc2luZyBmaXJzdCBlbnRyeS5cIik7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmdldExvZ2dlcigpLndhcm5pbmdQaWkoYE11bHRpcGxlIGVudHJpZXMgZm91bmQgZm9yOiAke2VuZHBvaW50fWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IGtleUZvckVuZHBvaW50ID0ga2V5TWF0Y2hlc0VuZHBvaW50QXJyYXlbMF07XHJcbiAgICAgICAgICAgIGlmIChrZXlGb3JFbmRwb2ludCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHByb3RlY3RlZFJlc291cmNlTWFwLmdldChrZXlGb3JFbmRwb2ludCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IFxyXG5cclxuICAgICAgICAvKlxyXG4gICAgICAgICAqIGRlZmF1bHQgcmVzb3VyY2Ugd2lsbCBiZSBjbGllbnRpZCBpZiBub3RoaW5nIHNwZWNpZmllZFxyXG4gICAgICAgICAqIEFwcCB3aWxsIHVzZSBpZHRva2VuIGZvciBjYWxscyB0byBpdHNlbGZcclxuICAgICAgICAgKiBjaGVjayBpZiBpdCdzIHN0YXJpbmcgZnJvbSBodHRwIG9yIGh0dHBzLCBuZWVkcyB0byBtYXRjaCB3aXRoIGFwcCBob3N0XHJcbiAgICAgICAgICovXHJcbiAgICAgICAgaWYgKGVuZHBvaW50LmluZGV4T2YoXCJodHRwOi8vXCIpID4gLTEgfHwgZW5kcG9pbnQuaW5kZXhPZihcImh0dHBzOi8vXCIpID4gLTEpIHtcclxuICAgICAgICAgICAgaWYgKFVybFV0aWxzLmdldEhvc3RGcm9tVXJpKGVuZHBvaW50KSA9PT0gVXJsVXRpbHMuZ2V0SG9zdEZyb21Vcmkoc3VwZXIuZ2V0UmVkaXJlY3RVcmkoKSkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgQXJyYXk8c3RyaW5nPih0aGlzLm1zYWxDb25maWcuYXV0aC5jbGllbnRJZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvKlxyXG4gICAgICAgICAgICAgKiBpbiBhbmd1bGFyIGxldmVsLCB0aGUgdXJsIGZvciAkaHR0cCBpbnRlcmNlcHRvciBjYWxsIGNvdWxkIGJlIHJlbGF0aXZlIHVybCxcclxuICAgICAgICAgICAgICogaWYgaXQncyByZWxhdGl2ZSBjYWxsLCB3ZSdsbCB0cmVhdCBpdCBhcyBhcHAgYmFja2VuZCBjYWxsLlxyXG4gICAgICAgICAgICAgKi9cclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBBcnJheTxzdHJpbmc+KHRoaXMubXNhbENvbmZpZy5hdXRoLmNsaWVudElkKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGlmIG5vdCB0aGUgYXBwJ3Mgb3duIGJhY2tlbmQgb3Igbm90IGEgZG9tYWluIGxpc3RlZCBpbiB0aGUgZW5kcG9pbnRzIHN0cnVjdHVyZVxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==